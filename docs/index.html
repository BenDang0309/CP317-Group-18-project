<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laurier Route Planner Prototype</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 90vh; width: 100%; }
    #controls {
      padding: 10px;
      background: #f4f4f4;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      align-items: center;
    }
    select, button, input { padding: 6px 10px; font-size: 14px; }
    input { width: 220px; }
    #info { text-align: center; padding: 5px; }
  </style>
</head>
<body>
  <div id="controls">
    <select id="routeSelect">
      <option value="">-- Select a preset route --</option>
      <option value="laurier_to_conestoga">Laurier ‚Üí Conestoga Mall</option>
      <option value="laurier_to_uptown">Laurier ‚Üí Uptown Waterloo</option>
      <option value="laurier_to_uwaterloo">Laurier ‚Üí University of Waterloo</option>
      <option value="laurier_to_rimpark">Laurier ‚Üí RIM Park</option>
    </select>
    <button onclick="showDummyRoute()">Show Preset</button>
    <input id="start" placeholder="Enter start address" />
    <input id="dest" placeholder="Enter destination address" />
    <button onclick="getAPIRoute()">Get Live Route</button>
    <button onclick="getUserLocation()">üìç Use My Location</button>
  </div>

  <div id="map"></div>
  <div id="info"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Initialize Leaflet map
    const map = L.map("map").setView([43.4731, -80.5267], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
    }).addTo(map);

    let routeLayer = null;
    let userMarker = null;
    let userCoords = null;

    // üîπ Dummy routes for presets
    const dummyRoutes = {
      laurier_to_conestoga: {
        polyline: [
          [43.4731, -80.5267],
          [43.4871, -80.5255],
          [43.4947, -80.5259],
          [43.5004, -80.5231],
        ],
        distance_m: 3800,
        duration_s: 540,
      },
      laurier_to_uptown: {
        polyline: [
          [43.4731, -80.5267],
          [43.4729, -80.523],
          [43.4687, -80.5205],
          [43.466, -80.5191],
        ],
        distance_m: 1500,
        duration_s: 260,
      },
      laurier_to_uwaterloo: {
        polyline: [
          [43.4731, -80.5267],
          [43.4745, -80.54],
          [43.4764, -80.544],
          [43.4776, -80.5475],
        ],
        distance_m: 2400,
        duration_s: 400,
      },
      laurier_to_rimpark: {
        polyline: [
          [43.4731, -80.5267],
          [43.486, -80.507],
          [43.5, -80.48],
          [43.5115, -80.452],
        ],
        distance_m: 8200,
        duration_s: 980,
      },
    };

    // üîπ Show dummy preset
    function showDummyRoute() {
      const choice = document.getElementById("routeSelect").value;
      if (!choice) {
        alert("Please select a preset route.");
        return;
      }
      const data = dummyRoutes[choice];
      drawRoute(data.polyline, data.distance_m, data.duration_s);
    }

    // üîπ Fetch live route from backend API
    async function getAPIRoute() {
      const start = document.getElementById("start").value;
      const dest = document.getElementById("dest").value;
      if (!start || !dest) {
        alert("Enter both start and destination addresses.");
        return;
      }

      try {
        const res = await fetch("http://localhost:8000/service/v1/route", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ start, destination: dest, mode: "driving" }),
        });

        if (!res.ok) throw new Error("Backend error");
        const data = await res.json();

        // Draw route
        drawRoute(data.polyline, data.distance_m, data.duration_s);

        // Show info and fallback source
        const km = (data.distance_m / 1000).toFixed(2);
        const min = data.duration_s ? (data.duration_s / 60).toFixed(1) : "N/A";
        const fallbackMsg = data.fallback
          ? "‚ö†Ô∏è (Fallback: Approximate straight-line distance used)"
          : "";
        document.getElementById("info").innerHTML = `
          <b>From:</b> ${data.start}<br>
          <b>To:</b> ${data.destination}<br>
          <b>Distance:</b> ${km} km | <b>Duration:</b> ${min} min ${fallbackMsg}
        `;
      } catch (err) {
        console.error(err);
        alert("Failed to fetch route. Ensure the backend is running on port 8000.");
      }
    }

    // üîπ Draw route on map
    function drawRoute(polyline, distance_m, duration_s) {
      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.polyline(polyline, { color: "blue", weight: 5 }).addTo(map);
      map.fitBounds(routeLayer.getBounds());
      const start = polyline[0];
      const end = polyline[polyline.length - 1];
      L.marker(start).addTo(map).bindPopup("Start").openPopup();
      L.marker(end).addTo(map).bindPopup("Destination");
    }

    // üìç Use My Location
    // üìç Use My Location
function getUserLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported by this browser.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      userCoords = [lat, lon];

      // Remove previous marker if exists
      if (userMarker) map.removeLayer(userMarker);

      // Add marker for current position
      userMarker = L.marker([lat, lon])
        .addTo(map)
        .bindPopup("You are here üìç")
        .openPopup();

      // Center map on user
      map.setView([lat, lon], 14);

      // ‚úÖ Auto-fill the start field
      const startInput = document.getElementById("start");
      startInput.value = `My Location (${lat.toFixed(5)}, ${lon.toFixed(5)})`;
      startInput.dataset.lat = lat;
      startInput.dataset.lon = lon;
    },
    (err) => {
      console.warn("Location error:", err);
      alert("Could not get your location.");
    }
  );
}

  </script>
</body>
</html>
